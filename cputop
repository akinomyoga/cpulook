#!/usr/bin/env bash

function cpudir.initialize {
  local _scr=$(readlink -f "$0" || /bin/readlink -f "$0" || printf '%s\n' "$0") 2>/dev/null
  local _dir=${_scr%/*}
  [[ $_dir == "$_scr" ]] && _dir=.
  if [[ -d ${_dir:=/} ]]; then
    cpudir=$_dir
  elif _dir=${XDG_DATA_HOME:-$HOME/.local/share}/cpulook; [[ -d $_dir ]]; then
    cpudir=$_dir
  elif _dir=${MWGDIR:-$HOME/.mwg}/share/cpulook; [[ -d $_dir ]]; then
    cpudir=$_dir
  fi
}
cpudir.initialize

source "$cpudir/cpudefs.sh"

function mwg_check {
  if ! eval "$1"; then
    echo "$2" >&2
    exit 1
  fi
}

fA=
host=
while (($#)); do
  case "$1" in
  (-a)
    fA=1 # show all processes
    ;;
  (*)
    mwg_check "test -z '$host'" "$0:arg\"$1\": host is already specified!"
    host=$1
    ;;
  esac
  shift
done

mwg_check '[[ $host ]]' "$0: host is not specified!"

host=$($cpudir/cpugethost.sh "$host") || exit 1

if [[ $fA ]]; then
  rsh.dispatch "$host" COLUMNS=$((COLUMNS-1)) top -cb -n 1
else
  rsh.dispatch "$host" COLUMNS=$((COLUMNS-1)) top -cb -n 1 | awk '$1=="PID"{head=1;print;next} !head||$8!="S"||$9!=0{print}'
fi
